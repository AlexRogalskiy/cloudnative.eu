user  nginx;
worker_processes  1;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
  worker_connections  1024;
}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

  access_log  off;
  sendfile        on;
  #tcp_nopush     on;
  keepalive_timeout  65;
  gzip  on;

  server {
    listen       80;
    server_name  localhost;

    root   /usr/share/nginx/html;
    index  index.html index.htm;

    ## redirects

    # location = /about-us/ {
    #   return 301 https://example.com/new-link/;
    # }

    location = /feed { return 301 https://angularjs.de/feed.xml; }
    location = /artikel.atom { return 301 https://angularjs.de/feed.xml; }
    location = /workshops { return 301 https://angularjs.de/workshops/angular-intensiv; }
    location = /workshops/angularjs-intensiv { return 301 https://angularjs.de/workshops/angular-intensiv; }
    location = /workshops/angular2-intensiv { return 301 https://angularjs.de/workshops/angular-intensiv; }
    location = /workshops/angular2-intensiv/vorbereitung { return 301 https://angularjs.de/workshops/angular-intensiv; }
    location = /firmenschulung { return 301 https://angularjs.de/inhouse-workshop; }
    location = /ngQuillReleases { return 301 https://angularjs.de; }
    location = /example { return 301 https://angularjs.de; }
    location = /example { return 301 https://angularjs.de; }
    location = /angularjs-workshop-schulung-seminar { return 301 https://angularjs.de/workshops/angularjs-intensiv; }
    location = /consulting { return 301 https://angularjs.de/inhouse-workshop; }
    location = /inquiries/new { return 301 https://angularjs.de/inhouse-workshop; }
    location = /inquiries/new { return 301 https://angularjs.de/inhouse-workshop; }
    location = /inhouse-workshop-anfrage { return 301 https://angularjs.de/inhouse-workshop; }

    # get "/jobs*****", RedirectPlug, "/jobs"
    # get "/events/:id", RedirectPlug, "/veranstaltungen/%{id}"
    # get "/blog/:id", RedirectPlug, "/artikel/%{id}"

    # get "/classroom/*path", RedirectPlug, "https://workshops.de/classroom/%{path}?token=%{token}"
    # get "/veranstaltungsorte/*path", RedirectPlug, "https://workshops.de/veranstaltungsorte/%{path}"
    # get "/veranstaltungen/*path", RedirectPlug, "/workshops/angular-intensiv"

    # # merged articles
    # get "/artikel/angular2-tutorial-deutsch-teil-2", RedirectPlug, "/artikel/angular2-tutorial-deutsch"
    # get "/artikel/ionic-tutorial-deutsch-teil-1", RedirectPlug, "/artikel/ionic-tutorial-deutsch"

    set $res "-";
    if ($http_x_forwarded_proto = "http") {
      set $res  A;
    }

    if ($http_user_agent !~ GoogleHC) {
      set $res  "${res}B";
    }

    if ($res = AB) {
      return 301 https://$host$request_uri;
    }

    if ($host ~* ^www\.(.*)$) {
      return 301 https://$1;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|eot|ttf|woff|woff2)$ {
      expires 1y;
      log_not_found off;
    }

    location ~* \.(html|xml)$ {
      expires 2m;
      log_not_found off;
    }

    # remove trailing /
    rewrite ^/index.html$ / permanent;
    rewrite ^(/.+)/$ $1 permanent;
    rewrite ^(/.+)/index.html$ $1 permanent;

    # redirect server error pages to the static page /50x.html
    error_page 404 /404/index.html;
    error_page 500 502 503 504  /50x.html;
    location = /50x.html {
      root   /usr/share/nginx/html;
    }

    location / {
      add_header  X-Robots-Tag "noindex, nofollow, nosnippet, noarchive";
      try_files $uri $uri/index.html =404;
    }

    # Optimizing & Speeding up
    etag off;
    gzip on;
    gzip_min_length  1100;
    gzip_buffers  4 32k;
    gzip_proxied any;
    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript text/x-js image/svg+xml application/vnd.ms-fontobject application/x-font-ttf font/opentype;
    gzip_vary on;
    gzip_comp_level 9;
    gzip_disable "MSIE [1-6]\.(?!.*SV1)";
  }
}
